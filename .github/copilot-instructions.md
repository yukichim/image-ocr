# GitHubCopilot-instructions.md (Tax & Accounting OCR)

# 🤖 Tax & Accounting OCR Development Guidelines

あなたは現在、**日本の税務・経理書類（レシート、請求書、決算書など）に特化したOCRエンジン**を開発しています。
高精度な日本語認識とレイアウト解析が求められます。

## 1. 技術スタックと環境 (Tech Stack)
* **Base:** Python 3.10+, PyTorch (MPS enabled)
* **Core OCR:** PaddleOCR (推奨: 日本語・表認識に強いため) または DBNet + CRNN/SVTR
* **Image Processing:** OpenCV (`cv2`), `numpy`
* **Layout Analysis:** `layoutparser` または独自ルールベース（座標計算）
* **Post-processing:** `re` (正規表現), `pandas` (表データ処理), `jaconv` (全角半角正規化)

## 2. 実装上の重要方針 (Implementation Policy)

### A. 書類タイプ別の戦略 (Document Specifics)
コードを提案する際は、対象の書類タイプを意識したロジックを組むこと。

* **レシート/領収書:**
    * 「長い紙」に対応するため、画像を適宜分割して推論するか、入力サイズ制限に注意する。
    * **軽減税率判定:** 商品名や金額の近くにある `※` `軽` `8%` などの記号を、座標距離（IoUやユークリッド距離）を用いて行ごとに紐付けるロジックを実装する。
* **決算書/財務諸表:**
    * **表構造解析 (Table Structure Recognition):** 単なるテキスト列ではなく、`Line Item` (勘定科目) と `Value` (金額) の**水平方向の整列**を検知するアルゴリズムを優先する。
    * 罫線 (`cv2.HoughLinesP`等) を利用したセル分割も検討候補に入れる。
* **源泉徴収票:**
    * 固定レイアウトのため、テンプレートマッチングまたは相対座標指定での抽出（ROI設定）を提案する。

### B. 日本語特有の処理 (Japanese Handling)
* **縦書き対応:** 請求書の印鑑や、封筒の宛名などで縦書きが出現するため、縦書き対応のモデル設定（`direction='vertical'` 等）やロジックを入れる。
* **日付の正規化:** 和暦（明治、大正、昭和、平成、令和）と西暦の混在に対応する変換関数（`wareki_to_seireki`）を必ず実装ユーティリティに含める。
    * 例: `R5.10.1` -> `2023-10-01`
* **漢数字:** 縦書き領収書などで「金壱萬円」などの表記がある場合、算用数字への変換ロジックを考慮する。

### C. データの信頼性 (Reliability)
* **金額のバリデーション:** OCRで読み取った「小計」「消費税」の合計が「合計金額」と一致するか検算するロジック(`validate_totals`)を提案する。一致しない場合はWarningを出す。

## 3. コーディングルール (Coding Standards)

### A. 座標データの扱い
* Bounding Box (BBox) は、後工程の計算（距離判定など）で頻繁に使用するため、統一したデータクラスまたは辞書形式で扱う。
    ```python
    # 推奨フォーマット
    {'text': '品代', 'box': [x_min, y_min, x_max, y_max], 'confidence': 0.98}
    ```

### B. 正規表現の活用
* 金額抽出 (`¥?[0-9,]+`) や 日付抽出 (`\d{4}年\d{1,2}月`) は、OCRの揺らぎ（"l" が "1" になる等）を吸収できる柔軟な正規表現パターンを提案する。

## 4. プロンプトへの応答姿勢
* 複雑なレイアウト解析（例：決算書の表）については、いきなりDeep Learningモデルを使わず、まずは**OpenCVによる輪郭抽出や射影ヒストグラム（Projection Profile）**を用いた軽量かつ高速なアプローチが可能か検討・提案すること。
* 「軽減税率の自動判定」のように確率的な要素を含む場合は、判定根拠（「"軽"マークが右隣5px以内にあったため」など）をログに残す設計にすること。

---